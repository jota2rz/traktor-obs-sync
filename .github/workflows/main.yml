name: 'Build Portable Binaries'

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  windows-build:
    name: 'Windows'
    runs-on: windows-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python Prerequisites
        run: pip install -r requirements.txt pyinstaller

      - name: Run PyInstaller
        run: pyinstaller main.py --distpath . --onefile --name traktor-obs-sync

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: traktor-obs-sync-Windows
          path: |
            traktor-obs-sync*
            !*.spec
            player
            media
            config.ini
  linux-build:
    name: 'Linux'
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python Prerequisites
        run: pip install -r requirements.txt pyinstaller

      - name: Run PyInstaller
        run: pyinstaller main.py --distpath . --onefile --name traktor-obs-sync

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: traktor-obs-sync-Linux
          path: |
            traktor-obs-sync*
            !*.spec
            player
            media
            config.ini
  macos-build:
    name: 'macOS'
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Universal2 Python from python.org
        run: |
          PYTHON_VERSION="3.13.2"
          PKG_NAME="python-${PYTHON_VERSION}-macos11.pkg"
          curl -sSL "https://www.python.org/ftp/python/${PYTHON_VERSION}/${PKG_NAME}" -o "/tmp/${PKG_NAME}"
          sudo installer -pkg "/tmp/${PKG_NAME}" -target /
          echo "/Library/Frameworks/Python.framework/Versions/3.13/bin" >> $GITHUB_PATH

      - name: Verify Universal2 Python
        run: |
          python3 --version
          file $(which python3)
          python3 -c "import struct; print(f'Pointer size: {struct.calcsize(\"P\") * 8}-bit')"

      - name: Install Python Prerequisites
        run: python3 -m pip install -r requirements.txt pyinstaller

      - name: Run PyInstaller
        run: python3 -m PyInstaller main.py --distpath . --onefile --name traktor-obs-sync --target-arch universal2

      - name: Verify Universal Binary
        run: |
          file traktor-obs-sync
          lipo -info traktor-obs-sync

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: traktor-obs-sync-macOS
          path: |
            traktor-obs-sync
            player
            media
            config.ini
